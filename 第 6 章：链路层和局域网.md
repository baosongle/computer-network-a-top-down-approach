# 第 6 章：链路层和局域网

链路层提供的基本服务是将数据报通过单一通信链路从一个节点移动到相邻节点。不同链路层协议提供的服务不同，基本上包括了下面协议

- **成帧（framing）**：将上层传下来的数据包装成链路层帧
- **链路接入**：媒体访问控制（Medium Access Control，MAC）规定了帧在链路上的传递规则，使得帧在有单一的发送方和接收方、或者多个发送方和接收方的情况下都能被正确传输
- **可靠交付**：运有些输层协议提供可靠交付，有些链路层协议也提供可靠交付功能，但并不是全部
- **差错检测和纠错**：由于链路层中的硬件可能发生硬件故障，故有时候数据报中的比特会发生翻转，链路层协议能够检测出这样的差错，有时候甚至能纠正错误

## 差错检测和纠错技术

链路层接到上层的应用数据后，加上自己的首部组成链路层数据报，放在链路中进行传播。传播中可能发生错误，因此需要有差错检测机制来发现链路层首部和应用数据的错误。差错检测可能并不能找到所有的错误，因此链路层可能向上层交付一个有差错的数据报，但是这种事情的发生概率比较低

差错检测常用的 3 种技术分别是：**奇偶校验**、**检验和方法**、**循环冗余检测**

**奇偶校验** 方法是其中最简单的一种。如果要发送 d 比特的数据，在这些数据的最后附加一个比特，共 d+1 比特，附加的比特使得所有的比特位中的 1 的个数是偶数。这样，当接收方收到数据后，只需要检查 d+1 比特的数据中的 1 的个数是不是偶数，如果不是则必定在传输过程中发生了错误；但是如果是，也并不意味着一定没有发生错误，因为有可能在两个地方发生了比特翻转使得 1 的个数仍为偶数，当然这样的事情发生的概率是比较低的

上面这样的奇偶校验方法是一维奇偶校验，后来还出现了 **二维奇偶校验** 方法。将所有的数据分为 i 行 j 列，对每一行附加一个比特，对每一列也附加一个比特，这样总共就附加了 i+j+1 比特。每一行和每一列的附加比特都让行和列的数字 1 的数量是偶数。当某一个比特数据发生错误后，我们发现在第 n 行和第 m 列的数字 1 的个数不是偶数，那么发生错误的数据就是 n 行 m 列的数据，这样我们就能把该比特数据翻转到另一个值，我们就纠正了数据错误，这种能力叫做 **前向纠错**。二维奇偶校验同样能发现多于一个比特的数据错误，但这种情况下就不能纠正错误了

**英特网检验和（Internet checksum）** 是另一种差错监测方法。从它的英文名称就可以看出，它是把二进制数据当做整数进行求和来检测差错的。比如，将数据按 16 比特分为多个整数，将所有整数求和，把和取反码就得到了检验和。把检验和附加在报文中。接收方收到数据和检验和后，同样按照 16 比特的分组把所有整数求和并取反码，如果得到的数全是 1 说明数据传输没有发生错误；而如果有一位是 0 就说明错误发生了

之前学习运输层时我们知道运输层的协议多是用检验和法，而链路层协议通常会用下面介绍的 CRC 方法。检验和方法相对于 CRC 来说偏弱一些，而因为运输层协议通常是由软件实现，因此运输层选择了偏弱但是计算更加快速的检验和方法。而链路层因为更加贴近底层硬件，而硬件专门对 CRC 提供支持，因此链路层选用了更强的 CRC

**循环冗余检测（Cyclic redundancy Check, CRC）** 是链路层使用的差错检测技术。这个方法国语复杂，我也并没有看懂，这里就不详细记录了

## 多路访问链路和协议

**多路访问问题** 研究如何协调多个发送和接受节点对同一个共享广播信道的访问。当两个或多个节点在信道上同时发送数据时，他们的信号会彼此 **碰撞（collide）**，发生碰撞后任何节点都不能从信道上接受数据。因此多路访问协议要决定谁在什么时候有发送数据的权力。目前有很多多路访问协议，可以分为以下三种

1. 信道划分协议
2. 随机接入协议
3. 轮流协议

对于一个速率是 R bps 的广播信道，多路访问协议最好有下面的特性

- 当仅有一个节点在发送数据时，节点应有 R bps 的吞吐量
- 当有 M 个节点在发送数据时，每个节点应有 R/M bps 的吞吐量。不一定要求每个节点在每个时间点都有 R/M bps 的吞吐量，而是在一个时间段内有这要的平均速率。这也要求每个节点都能平等的使用信道
- 协议不会因为单个节点的故障而崩溃
- 协议应是简单的，实现不昂贵

### 信道划分协议

信道划分协议有 3 种：**时分多路复用（TDM）**、**频分多路复用（FDM）** 和 **码分多址（CDMA）**

时分多路复用是把时间划分 **时间帧（time frame）**，而一个时间帧划分为为多个 **时隙（slot）**。时隙会被分配给各个节点，每个节点有数据要发送时，只能等待直到自己的时隙到来才能发送。TDM 非常公平，但是当只有一个节点要发送数据时，这个节点的吞吐量被限制在 R/M bps，不能到达信道的全速

频分多路复用把信道划分为不同的频段，频道的速率是 R/M bps，频段被分配给各个节点，各个节点可以同时发送数据而不会碰撞。FDM 与 TDM 一样公平但是当只有一个节点时不能全速发送

码分多址技术给每个节点分配不同的编码，精心选择编码可以使得当多个节点同时发送数据而不发生干扰

### 随机接入协议

随机接入协议中，每个节点总是以最大的速率发送数据，当有碰撞发生时，节点等待一个随机的时间后再次尝试发送数据。随机接入协议中比较常见的有 **ALOHA 协议** 和 **载波侦听多路访问协议（CSMA）**

#### 时隙 ALOHA

对时隙 ALOHA，我们做出下面的假设

- 所有帧由 L 比特组成
- 时间被划分为 L/R 的时隙，正好每一个时隙发送一帧
- 节点只在时隙的开始发送帧
- 节点是同步的，每个节点都知道时隙何时开始
- 如果在一个时隙中有两个或多个帧发生碰撞，节点会在时隙结束之前得知碰撞事件

对于 ALOHA 协议中的操作如下

- 当节点有数据要发送时，等到下一个时隙开始立即传送数据
- 如果没有碰撞，数据的发送就成功了。如果有新帧到来，立即发送
- 如果有碰撞，那么有 p 的概率在下一个时隙中发送数据，直到数据没有碰撞的发送出去

相比较于 TDM 和 FDM，ALOHA 协议同样公正，而且在只有一个节点有数据发送时，它能以全速发送数据。当有大量的节点存在时，节点间会因为碰撞而造成一些时隙被浪费。我们定义一个成功的时隙就是无碰撞的成功发送了数据的时隙，而效率就是成功的时隙占所有时隙的份额。通过计算表明，当有大量的节点有发送大量的数据时，ALOHA 协议的效率大约是 1/e = 37%，有 26% 的时隙发生了碰撞

#### 非时隙 ALOHA 协议

时隙 ALOHA 协议中有一个假设：节点之间是同步的。但第一版的 ALOHA 协议是一个非同步协议，即节点可以在任意时间点开始发送数据。去掉节点间的必须同步的假设后，我们可以得到非时隙 ALOHA 协议的效率是 1/(2e) ，比时隙 ALOHA 协议还要小一些

#### 载波侦听多路访问协议

在 ALOHA 协议中，节点决定是否发送数据与其他节点无关，这就导致当其他节点在发送数据时，另一个节点也开始发送数据就必定使得碰撞发生。而如果节点如果能够侦听到另一个节点正在发送数据，那么它决定在另一个节点结束发送数据后才发送自己的数据，这将避免碰撞的发生。这就是 **载波侦听** 原理

除此之外还有一个重要的原理叫做 **碰撞检测（collision detection）**，即节点在发送数据时同时也在侦听网络，一些发生另一个节点发送的信号与自己发送的信号相互干扰后就立即停止发送

这两个规则被包含在 **载波侦听多路访问协议（Carrier Sense Multiple Access, CSMA）** 和 **具有碰撞检测的 CSMA（CSMA with Collision Detection, CSMA/CD）** 协议族中

如果说节点具有载波侦听功能，那么为什么还会发生碰撞呢？这是因为信号在信道中传播的速度是有限的，当一个节点 A 开始传送数据后，另一个节点 B 可能需要过一段时间才能侦听到信号，如果 B 在侦听到信号之前也开始传送数据，那么此时碰撞就发生了

在检测到碰撞后，节点会等待一个随机的时间后再次尝试发送数据。这个随机的时间量选择也是有一个算法的，叫做 **二进制指数后退（binary exponential backoff）**。即当节点连续发生 n 次碰撞后，它会从 {0, 1, 2, 4, ... , 2^n -1 } 的常数中随机选择一个值 K 。在以太网协议中，等待的时间是 K * 传送 512 比特所需要的时间，作为随机等待的时间。n 能取到的最大值一般是 10

经过一系列复杂的计算，我们可以得到 CSMA/CD 的效率是 1 / (1 + 5 d1/d2) ，其中 d1 是信号在两个节点间传播所需要的最大时间，d2 是传递一个最大长度的以太网帧所需要的时间。当 d1 越小时，传播速率越接近于 1 ，即信号传播速度越快，碰撞越不可能发生

### 轮流协议

轮流协议（taking-turns protocol）也有很多种。

第一种轮流协议是 **轮询协议（polling protocol）**。这个协议要求一个节点被指定为主节点，主节点轮询每个节点，告诉每个节点它能传送的帧的数量。比如主节点告诉节点 1 它能传送的帧的数量，当节点 1 传送完这些帧后，主节点告诉节点 2 能传送的帧的数量，依此类推。这个协议需要轮询每个节点，这就引入了轮询时延，导致效率有所降低。第二个缺点是当主节点出现故障，整个信道都不可用了。802.15 协议和蓝牙协议就使用了轮询协议

第二种轮流协议是 **令牌传递协议（token-passing protocol）**。这个协议没有主节点，而是存在一个称为 **令牌（token）** 的特殊帧，令牌只有一个，在每个节点之间以固定的次序传输。如果一个节点有数据需要发送，它会尝试去获取令牌，只有当它拿到令牌后才会开始发送数据。如果节点拿到了令牌却没有数据需要发送，那么它会把令牌传递给下一个节点。下一个节点会根据自己有没有数据需要发送而决定是自己保留令牌还是传给另一个节点。令牌传送协议效率很高且分散，但是也有自己的缺点。如果一个节点发生故障，没有适时交出令牌，那么整个网络将会瘫痪，必须通过某种令牌恢复策略才能从瘫痪中恢复



