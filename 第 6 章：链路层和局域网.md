# 第 6 章：链路层和局域网

链路层提供的基本服务是将数据报通过单一通信链路从一个节点移动到相邻节点。不同链路层协议提供的服务不同，基本上包括了下面协议

- **成帧（framing）**：将上层传下来的数据包装成链路层帧
- **链路接入**：媒体访问控制（Medium Access Control，MAC）规定了帧在链路上的传递规则，使得帧在有单一的发送方和接收方、或者多个发送方和接收方的情况下都能被正确传输
- **可靠交付**：运有些输层协议提供可靠交付，有些链路层协议也提供可靠交付功能，但并不是全部
- **差错检测和纠错**：由于链路层中的硬件可能发生硬件故障，故有时候数据报中的比特会发生翻转，链路层协议能够检测出这样的差错，有时候甚至能纠正错误

## 差错检测和纠错技术

链路层接到上层的应用数据后，加上自己的首部组成链路层数据报，放在链路中进行传播。传播中可能发生错误，因此需要有差错检测机制来发现链路层首部和应用数据的错误。差错检测可能并不能找到所有的错误，因此链路层可能向上层交付一个有差错的数据报，但是这种事情的发生概率比较低

差错检测常用的 3 种技术分别是：**奇偶校验**、**检验和方法**、**循环冗余检测**

**奇偶校验** 方法是其中最简单的一种。如果要发送 d 比特的数据，在这些数据的最后附加一个比特，共 d+1 比特，附加的比特使得所有的比特位中的 1 的个数是偶数。这样，当接收方收到数据后，只需要检查 d+1 比特的数据中的 1 的个数是不是偶数，如果不是则必定在传输过程中发生了错误；但是如果是，也并不意味着一定没有发生错误，因为有可能在两个地方发生了比特翻转使得 1 的个数仍为偶数，当然这样的事情发生的概率是比较低的

上面这样的奇偶校验方法是一维奇偶校验，后来还出现了 **二维奇偶校验** 方法。将所有的数据分为 i 行 j 列，对每一行附加一个比特，对每一列也附加一个比特，这样总共就附加了 i+j+1 比特。每一行和每一列的附加比特都让行和列的数字 1 的数量是偶数。当某一个比特数据发生错误后，我们发现在第 n 行和第 m 列的数字 1 的个数不是偶数，那么发生错误的数据就是 n 行 m 列的数据，这样我们就能把该比特数据翻转到另一个值，我们就纠正了数据错误，这种能力叫做 **前向纠错**。二维奇偶校验同样能发现多于一个比特的数据错误，但这种情况下就不能纠正错误了

**英特网检验和（Internet checksum）** 是另一种差错监测方法。从它的英文名称就可以看出，它是把二进制数据当做整数进行求和来检测差错的。比如，将数据按 16 比特分为多个整数，将所有整数求和，把和取反码就得到了检验和。把检验和附加在报文中。接收方收到数据和检验和后，同样按照 16 比特的分组把所有整数求和并取反码，如果得到的数全是 1 说明数据传输没有发生错误；而如果有一位是 0 就说明错误发生了

之前学习运输层时我们知道运输层的协议多是用检验和法，而链路层协议通常会用下面介绍的 CRC 方法。检验和方法相对于 CRC 来说偏弱一些，而因为运输层协议通常是由软件实现，因此运输层选择了偏弱但是计算更加快速的检验和方法。而链路层因为更加贴近底层硬件，而硬件专门对 CRC 提供支持，因此链路层选用了更强的 CRC

**循环冗余检测（Cyclic redundancy Check, CRC）** 是链路层使用的差错检测技术。这个方法国语复杂，我也并没有看懂，这里就不详细记录了

## 多路访问链路和协议

**多路访问问题** 研究如何协调多个发送和接受节点对同一个共享广播信道的访问。当两个或多个节点在信道上同时发送数据时，他们的信号会彼此 **碰撞（collide）**，发生碰撞后任何节点都不能从信道上接受数据。因此多路访问协议要决定谁在什么时候有发送数据的权力。目前有很多多路访问协议，可以分为以下三种

1. 信道划分协议
2. 随机接入协议
3. 轮流协议

对于一个速率是 R bps 的广播信道，多路访问协议最好有下面的特性

- 当仅有一个节点在发送数据时，节点应有 R bps 的吞吐量
- 当有 M 个节点在发送数据时，每个节点应有 R/M bps 的吞吐量。不一定要求每个节点在每个时间点都有 R/M bps 的吞吐量，而是在一个时间段内有这要的平均速率。这也要求每个节点都能平等的使用信道
- 协议不会因为单个节点的故障而崩溃
- 协议应是简单的，实现不昂贵

### 信道划分协议

信道划分协议有 3 种：**时分多路复用（TDM）**、**频分多路复用（FDM）** 和 **码分多址（CDMA）**

时分多路复用是把时间划分 **时间帧（time frame）**，而一个时间帧划分为为多个 **时隙（slot）**。时隙会被分配给各个节点，每个节点有数据要发送时，只能等待直到自己的时隙到来才能发送。TDM 非常公平，但是当只有一个节点要发送数据时，这个节点的吞吐量被限制在 R/M bps，不能到达信道的全速

频分多路复用把信道划分为不同的频段，频道的速率是 R/M bps，频段被分配给各个节点，各个节点可以同时发送数据而不会碰撞。FDM 与 TDM 一样公平但是当只有一个节点时不能全速发送

码分多址技术给每个节点分配不同的编码，精心选择编码可以使得当多个节点同时发送数据而不发生干扰

### 随机接入协议

随机接入协议中，每个节点总是以最大的速率发送数据，当有碰撞发生时，节点等待一个随机的时间后再次尝试发送数据