# 第二章 应用层 第二周

## UDP

UDP 也是运输层协议，但它不是面向连接的，因此没有握手的过程；同时，UDP 提供不可靠的传输服务，因此通过 UDP 发送的报文不一定能到达另一个主机，而且报文到达的顺序也是不确定的。UDP 也不提供拥塞控制功能

## HTTP

HTTP 即超文本传输协议(HyperText Transfer Protocol)，是建立在 TCP 连接之上的应用层协议，因此 HTTP 协议不用担心数据在传输过程中会发生丢失和乱序的问题

HTTP 协议是无状态的协议，意味着服务器不保存任何客户端的信息

HTTP 协议可以使用持续连接或者非持续连接。持续连接意味着当客户端连续发送多个请求时，这些请求都是在同一个 TCP 连接上发送的，避免了 TCP 被建立时因分配缓冲区等而对服务器造成的压力，以及握手阶段带来的巨大延迟

浏览器有时候会缓存一个 GET 请求的结果，这样当下一次浏览器访问同一个地址时，就不用再向服务器请求相同的资源了，可以直接使用已经缓存的资源。但是这样又引入了缓存有效性的问题，幸好 HTTP 自带一个解决方案：当浏览器访问一个已经有缓存的资源时，它会发送一个条件性 GET 请求，即在 GET 请求中加入 `If-Modified-Since` 头，这个头的内容是浏览器缓存资源的时间，当服务器没有在这个时间修改资源，服务器就会返回 304 Not Modified 状态码，这时浏览器就能安心的使用缓存资源了

## 邮件传输协议

英特网能提供的另一项服务就是首发电子邮件了，从一个人（比如说 Alice）发送电子邮件，到另一个人（比如说 Bob）接受电子邮件，其中牵涉到很多的东西。首先，这里牵涉到至少 4 个进程：Alice 的用户代理，Alice 的邮件服务器，Bob 的用户代理，Bob 的邮件服务器。除此之外，还牵涉到发送电子邮件的协议：SMTP

SMTP 是一个推协议，即客户端主动推送数据到服务端。在 Alice 写好了电子邮件后，她在她的用户代理上点击了发送按钮，这时用户代理作为客户端，主动连接到邮件服务器的 25 号端口，将邮件的内容通过 SMTP 协议发送过来。在 Alice 的邮件服务器接受到了邮件数据后，将其放入了它自己维护的队列。邮件服务器将作为客户端，使用 SMTP 协议把 Alice 的邮件推送到 Bob 的邮件服务器，如果推送失败了，那么客户邮件服务器将在 30 分钟之后重试一次

那么 Bob 怎样才能收到来自 Alice 的邮件呢？Bob 的用户代理使用 SMTP 协议去获取邮件吗？不是，因为 SMTP 是一个推协议，只负责数据的推送，而 Bob 的用户代理需要把邮件数据拉过来，因此就需要使用邮件访问访问协议了，常用的邮件访问协议有 POP3、IMAP 和 HTTP

POP3 协议比较简单，与 HTTP 一样它不保存会话中的状态信息，因此才保证了简洁的特性。而 IMAP 协议相对更加复杂，它邮件服务器把一个邮件和一个文件夹关联起来，这样让用户更加方便的管理邮件

## DNS

DNS 主要提供了将域名转换成 IP 地址的服务，另外还有主机别名、邮件服务器别名和负载分配的服务。DNS 使用端口 53

DNS 使用了分布式的服务部署方式，全球范围内共有 3 种 DNS服务器：根 DNS 服务器、顶级域 DNS 服务器和权威 DNS 服务器。根和顶级域 DNS 服务器是公共的，而公司和组织可以选择搭建自己的权威 DNS 服务器。在有些网络上还存在着本地 DNS 服务器，这通常是由 ISP 自行搭建的，以加快 DNS 服务的速度

并不是每次 DNS 查询都需要涉及到根 DNS 服务器，因为各级服务器都能实现缓存，这样极大的加快了访问速度

## P2P

在分发一个大文件时，可以使用传统的 CS 模式，由一个服务端向多个客户端分发文件，但是如果客户端数量太大，分发文件需要的时间也越慢(僧多粥少)；但如果使用 P2P 技术，每个客户端又可以充当服务端，这样就极大的降低了服务端的压力

文件数据在客户端之间以块的形式分配，每一块的大小通常是 256KB，一个客户端会查询哪些块是临近客户端中最稀缺的块，并优先请求这些块的数据

每个客户端也会计算是哪 4 个客户端向他发送的数据速率最大，它就会优先向这些客户端发送自己的数据。但每过 30 秒它会随机选择一个临近客户端，并向他发送自己的数据，这样的话它自己的最大接受速率前 4 个客户端不会一直保持不变

## CDN

CDN，即内容分发网络，主要是把静态的网络数据，如视频、图片、静态网页，部署到离用户更近的服务器上，这样能够减轻服务器的压力，而且也减少了在网络上传输的数据量，能够减少网络的拥塞程度，这也就是为什么世界上有私有的 CDN、商用的 CDN 外，还有公司提供免费的 CDN

CDN 技术通常依赖于 DNS，当一个商业网站(网站 A)使用另一个网站(网站 B)的 CDN 服务时，A 会在自己的权威 DNS 服务器中加入 B 的权威 DNS 服务器地址，当用户请求 A 的视频数据，A 会返回 B 的 DNS 服务器地址，B 会把自己的 CDN 集群的 IP 地址返还给用户，这样用户就从 B 获取到视频数据了，而不是从 A 获取数据

对于 B 来说，一个核心问题是集群选择策略，常用的有 **地理最近策略**，即返回地理上距离用户最近的 CDN 集群地址，这个方法很简单，但是问题是地理上最近并不意味着网络环境是最优的；另外一个策略是 **实时测量**，这个策略给用户返回一个网络环境最优的集群，但是实施起来可能比较复杂

分发像视频这样的大数据，除了使用 CDN 外，还可以使用 P2P 技术，迅雷看看、PPTV 都使用了 P2P 技术